apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: cert-manager
  namespace: security
spec:
  interval: 12h
  timeout: 10m
  releaseName: cert-manager
  chart:
    spec:
      chart: cert-manager
      version: 1.5.13
      sourceRef:
        kind: HelmRepository
        name: bitnami
        namespace: flux-system
      interval: 12h

  # Install configuration
  install:
    crds: Create
    remediation:
      retries: 3
    timeout: 10m
  
  # Upgrade configuration
  upgrade:
    crds: CreateReplace
    remediation:
      retries: 3
      remediateLastFailure: true
    timeout: 10m
  
  values:
    # ===== Global Configuration =====
    global:
      # Log level (0-6, 2 is recommended for production)
      logLevel: 2
    
    # Install CRDs as part of the Helm release
    installCRDs: true
    
    # Override namespace for ClusterIssuer resources
    clusterResourceNamespace: security
    
    # Leader election namespace
    leaderElection:
      namespace: security
    
    # RBAC configuration
    rbac:
      create: true
    
    # ===== Controller Configuration =====
    controller:
      replicaCount: 1
      
      # Resource limits and requests
      resourcesPreset: "none"
      resources:
        requests:
          cpu: 10m
          memory: 32Mi
        limits:
          memory: 256Mi
      
      # Pod Security Context
      podSecurityContext:
        enabled: true
        fsGroup: 1000
        fsGroupChangePolicy: Always
        sysctls: []
        supplementalGroups: []
      
      # Container Security Context
      containerSecurityContext:
        enabled: true
        seLinuxOptions: {}
        runAsUser: 1000
        runAsGroup: 1000
        runAsNonRoot: true
        privileged: false
        allowPrivilegeEscalation: false
        capabilities:
          drop:
            - ALL
        seccompProfile:
          type: RuntimeDefault
        readOnlyRootFilesystem: true
      
      # Node selector
      nodeSelector:
        node-role.kubernetes.io/worker: ""
      
      # Pod labels for monitoring
      podLabels:
        app.kubernetes.io/part-of: security
      
      # Enable Gateway API support for Traefik
      extraArgs:
        - --enable-gateway-api=true
      
      # Service Account - MUST be mounted for cert-manager to work
      serviceAccount:
        create: true
        automountServiceAccountToken: true
      
      # Network Policy
      networkPolicy:
        enabled: false
      
      # Pod Disruption Budget
      pdb:
        create: false
    
    # ===== Webhook Configuration =====
    webhook:
      replicaCount: 1
      
      # Timeout for webhook responses
      timeoutSeconds: 30
      
      # Container ports
      containerPorts:
        https: 10250
        health: 6080
      
      # Resource limits
      resourcesPreset: "none"
      resources:
        requests:
          cpu: 10m
          memory: 32Mi
        limits:
          memory: 128Mi
      
      # Pod Security Context
      podSecurityContext:
        enabled: true
        fsGroup: 1000
        fsGroupChangePolicy: Always
        sysctls: []
        supplementalGroups: []
      
      # Container Security Context
      containerSecurityContext:
        enabled: true
        seLinuxOptions: {}
        runAsUser: 1000
        runAsGroup: 1000
        runAsNonRoot: true
        privileged: false
        allowPrivilegeEscalation: false
        capabilities:
          drop:
            - ALL
        seccompProfile:
          type: RuntimeDefault
        readOnlyRootFilesystem: true
      
      # Service Account - MUST be mounted for webhook validation
      serviceAccount:
        create: true
        automountServiceAccountToken: true
      
      # Network Policy
      networkPolicy:
        enabled: false
      
      # Pod Disruption Budget
      pdb:
        create: false
    
    # ===== CA Injector Configuration =====
    cainjector:
      replicaCount: 1
      
      # Resource limits
      resourcesPreset: "none"
      resources:
        requests:
          cpu: 10m
          memory: 32Mi
        limits:
          memory: 256Mi
      
      # Pod Security Context
      podSecurityContext:
        enabled: true
        fsGroup: 1000
        fsGroupChangePolicy: Always
        sysctls: []
        supplementalGroups: []
      
      # Container Security Context
      containerSecurityContext:
        enabled: true
        seLinuxOptions: {}
        runAsUser: 1000
        runAsGroup: 1000
        runAsNonRoot: true
        privileged: false
        allowPrivilegeEscalation: false
        capabilities:
          drop:
            - ALL
        seccompProfile:
          type: RuntimeDefault
        readOnlyRootFilesystem: true
      
      # Service Account - MUST be mounted for CA injection
      serviceAccount:
        create: true
        automountServiceAccountToken: true
      
      # Network Policy
      networkPolicy:
        enabled: false
      
      # Pod Disruption Budget
      pdb:
        create: false
    
    # ===== Metrics Configuration =====
    metrics:
      enabled: false
      podAnnotations:
        prometheus.io/path: "/metrics"
        prometheus.io/scrape: "true"
        prometheus.io/port: "9402"
      serviceMonitor:
        enabled: false
